<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viper Forum</title>
    <script>
        // Security Check: If not logged in, boot to login page
        if (!localStorage.getItem('vUser')) window.location.href = "login.html";
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; margin: 0; padding: 20px; }
        .container { max-width: 750px; margin: 0 auto; }
        .nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .pfp { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #38bdf8; object-fit: cover; }
        .composer { background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155; margin-bottom: 30px; }
        input, textarea { width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        .post-card { background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155; margin-bottom: 20px; }
        .post-title { font-size: 1.3rem; color: #38bdf8; font-weight: bold; }
        .meta { font-size: 0.8rem; color: #94a3b8; display: flex; align-items: center; gap: 8px; margin: 10px 0; }
        .answer { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 3px solid #38bdf8; font-size: 0.9rem; }
        button { background: #38bdf8; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #7dd3fc; }
    </style>
</head>
<body>
<div class="container">
    <div class="nav">
        <h2>Viper Forum</h2>
        <div style="display:flex; align-items:center; gap:12px;">
            <img src="" id="myPfp" class="pfp"> <b id="myName"></b>
            <button onclick="localStorage.clear(); location.href='login.html';" style="background:#f87171;">Logout</button>
        </div>
    </div>

    <div class="composer">
        <input type="text" id="qTitle" placeholder="What is your question?">
        <textarea id="qContent" rows="3" placeholder="Explain your problem..."></textarea>
        <button onclick="sendPost()">Post to Community</button>
    </div>

    <div id="feed"></div>
</div>

<script>
    const BACKEND = "https://database-z8fs.onrender.com";
    const user = localStorage.getItem('vUser');
    const pfp = localStorage.getItem('vPfp');

    document.getElementById('myName').innerText = "@" + user;
    document.getElementById('myPfp').src = pfp;

    async function load() {
        const feed = document.getElementById('feed');
        feed.innerHTML = "<p style='text-align:center; color:#94a3b8;'>Waking up database... please wait...</p>";
        
        try {
            const res = await fetch(`${BACKEND}/forum/posts`);
            const data = await res.json();
            
            if (!data.posts || data.posts.length === 0) {
                feed.innerHTML = "<p style='text-align:center; color:#64748b;'>No posts yet.</p>";
                return;
            }
            render(data.posts);
        } catch (err) {
            feed.innerHTML = "<p style='text-align:center; color:#f87171;'>Server offline. Refresh in 10 seconds.</p>";
        }
    }

    function render(posts) {
        const feed = document.getElementById('feed');
        feed.innerHTML = posts.map(p => `
            <div class="post-card">
                <div class="post-title">${p.title}</div>
                <div class="meta">
                    <img src="${p.pfp || 'https://via.placeholder.com'}" class="pfp" style="width:25px;height:25px;"> 
                    By @${p.username} â€¢ ${new Date(p.created_at).toLocaleDateString()}
                </div>
                <div style="margin: 15px 0; line-height: 1.5;">${p.content}</div>
                
                <div style="font-size:0.75rem; color:#38bdf8; font-weight:bold; text-transform:uppercase; letter-spacing:1px;">Answers</div>
                <div id="replies-${p.id}">
                    ${p.replies.map(r => `
                        <div class="answer">
                            <div class="meta" style="margin:0 0 5px 0;">
                                <img src="${r.pfp}" style="width:18px;height:18px;border-radius:50%;"> @${r.username}
                            </div>
                            ${r.message}
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <input id="in-${p.id}" placeholder="Type a reply..." style="margin:0;">
                    <button onclick="sendReply('${p.id}')">Reply</button>
                </div>
            </div>
        `).join('');
    }

    async function sendPost() {
        const title = document.getElementById('qTitle').value;
        const content = document.getElementById('qContent').value;
        if (!title || !content) return alert("Please fill out both fields.");

        await fetch(`${BACKEND}/forum/post`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: user, pfp, title, content })
        });
        document.getElementById('qTitle').value = '';
        document.getElementById('qContent').value = '';
        load();
    }

    async function sendReply(postId) {
        const input = document.getElementById(`in-${postId}`);
        if (!input.value) return;

        await fetch(`${BACKEND}/forum/reply`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ postId, username: user, pfp, message: input.value })
        });
        input.value = '';
        load();
    }

    load();
</script>
</body>
</html>
