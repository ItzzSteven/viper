<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viper Forum</title>
    <script>if (!localStorage.getItem('vUser')) window.location.href = "/login";</script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; margin: 0; padding: 20px; }
        .container { max-width: 750px; margin: 0 auto; }
        .nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .pfp { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #38bdf8; }
        .composer { background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155; margin-bottom: 30px; }
        input, textarea { width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        .post-card { background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155; margin-bottom: 20px; }
        .post-title { font-size: 1.3rem; color: #38bdf8; font-weight: bold; }
        .meta { font-size: 0.8rem; color: #94a3b8; display: flex; align-items: center; gap: 8px; margin: 10px 0; }
        .answer { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 3px solid #38bdf8; }
        button { background: #38bdf8; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <div class="nav">
        <h2>Viper</h2>
        <div style="display:flex; align-items:center; gap:10px;">
            <img src="" id="myPfp" class="pfp"> <b id="myName"></b>
            <button onclick="localStorage.clear(); location.reload();" style="background:#f87171;">Logout</button>
        </div>
    </div>

    <div class="composer">
        <input type="text" id="qTitle" placeholder="Question Title">
        <textarea id="qContent" placeholder="Describe your problem..."></textarea>
        <button onclick="sendPost()">Ask Question</button>
    </div>

    <div id="feed"></div>
</div>

<script>
    const BACKEND = "https://iocqgwpasisiivhzsdjc.supabase.co";
    const user = localStorage.getItem('vUser');
    const pfp = localStorage.getItem('vPfp');

    document.getElementById('myName').innerText = "@" + user;
    document.getElementById('myPfp').src = pfp;

    async function load() {
        const res = await fetch(`${BACKEND}/forum/posts`);
        const data = await res.json();
        render(data.posts);
    }

    function render(posts) {
        feed.innerHTML = posts.map(p => `
            <div class="post-card">
                <div class="post-title">${p.title}</div>
                <div class="meta"><img src="${p.pfp}" class="pfp"> Asked by @${p.username} on ${new Date(p.created_at).toLocaleDateString()}</div>
                <div style="margin-bottom:20px;">${p.content}</div>
                
                <div style="font-size:0.8rem; color:#38bdf8; font-weight:bold;">ANSWERS</div>
                ${p.replies.map(r => `
                    <div class="answer">
                        <div class="meta" style="margin:0 0 5px 0;"><img src="${r.pfp}" style="width:20px;height:20px;border-radius:50%;"> @${r.username}</div>
                        ${r.message}
                    </div>
                `).join('')}
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <input id="in-${p.id}" placeholder="Type an answer..." style="margin:0;">
                    <button onclick="sendReply('${p.id}')">Reply</button>
                </div>
            </div>
        `).join('');
    }

    async function sendPost() {
        await fetch(`${BACKEND}/forum/post`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: user, pfp, title: qTitle.value, content: qContent.value })
        });
        qTitle.value = ''; qContent.value = ''; load();
    }

    async function sendReply(id) {
        const msg = document.getElementById(`in-${id}`).value;
        await fetch(`${BACKEND}/forum/reply`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ postId: id, username: user, pfp, message: msg })
        });
        load();
    }

    load();
</script>
</body>
</html>
